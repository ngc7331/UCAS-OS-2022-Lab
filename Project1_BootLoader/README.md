# Project 1



---
## 代码说明
注：实验前由老师给出、且未作修改的代码不再说明
注：我将用户程序 (APP) 和批处理 (batch) 统称为任务 (task)，共用`task_info_t`结构存储相关信息，但在内核载入的时候分开存入了两个数组`apps[]`和`batchs[]`

### Bootloader
#### arch/riscv/boot/bootblock.S
载入内核并启动，代码比较简单且对应位置均有注释，不再赘述



### 内核
#### arch/riscv/kernel/head.S
清空bss段，设置栈指针，跳转到内核

#### init/main.c
内核的主程序，启动时：
1. 检查 bss 段
2. 初始化 bios 的函数跳转表
3. 初始化任务信息：
   1. 从镜像固定位置（已载入内存）读取任务信息的位置和数量
   2. 载入任务信息，并根据类型存入`apps[]`和`batchs[]`数组，分别记录数量
4. 遍历所有批处理任务，执行那些被设为自动运行的（`task.execute_on_load==1`），关于批处理文件[见后文](#批处理)
5. 获取一行用户输入
   1. 若为 `help`，输出帮助信息（使用提示和任务列表）
   2. 若为 `batch *`，加载并执行对应批处理
   3. 否则，加载并执行对应用户程序
   4. 若2批处理或3用户程序名无效，报错
6. 从5循环



### 内核库
#### libs/console.c
对`bios_putchar()`等函数的封装，用于读取键盘输入、输出字符到屏幕
- `console_getchar()`：获取一个有效字符（非`-1`）
- `console_parsechar()`：获取一个有效字符，并回显到屏幕，对退格、换行、方向键特殊处理
- `console_getline()`：获取一行输入（读取到换行符，或缓冲区满结束），对退格、方向键特殊处理
- `str_format()`：简单的字符串格式化，把格式串的`_`替换为有效字符，且消除多余`_`
- `console_print()`：对`str_format()`的封装，格式化字符串并打印到屏幕

#### libs/task.c
任务相关函数（不含loader）
- `get_taskid_by_name()`：通过任务名和任务类型返回任务id（即数组下标），无匹配任务返回`-1`
- `run_batch()`：运行批处理

#### libs/task.h
- 任务类型`task_type_t`和任务信息`task_info_t`的类型定义
- 内存地址等宏定义

#### utils.c
实用函数
- `is_space()`：是否为空白字符（目前为制表符`\t`或空格` `）
- `atoi()`：字符串转整型，忽略非数字的字符
- `itoa()`：整型转字符串，支持2、8、10、16进制，支持补零到指定位数
- `[l][r]strip()`：去除字符串左/右/两端的多余空白字符

#### kernel/loader/loader.c
- `load_img()`：对`bios_sdread()`的封装，按字节（而非扇区）读取sd卡到内存，支持两种模式：
  - `copy == 0`：不移动数据，返回`memaddr + offset`，即所需数据的第一个字节存放在内存上的真实位置（`memaddr`处为该字写所在的扇区的第一个字节）。适用于批处理文件、`task_info[]`数组这类对内存地址不敏感的数据
  - `copy == 1`：移动数据，使所需数据的第一个字节存在`memaddr`处，返回`memaddr`。适用于应用程序
- `load_task_img`：对`load_img()`的封装，根据任务id和任务类型加载任务



### 用户程序
#### arch/riscv/crt0/crt0.S
先将返回内核的地址（即进入时`ra`寄存器的值）存入栈中、随后清空bss段、跳转到用户程序的`main()`函数、返回后从栈中读取地址并返回

#### test/test_project1/helloworld.c
调用 bios 输出`[hello] Hello from user app!`



---
## 使用说明
### OS
`make all`即可编译，环境变量中需要有 riscv64 交叉编译环境
`make run`即可使用 qemu 环境运行，qemu目录位于`~/OSLab-RISC-V/qemu`

#### 使用
输入`loadboot`启动系统

启动时自动运行被设为自动运行（`task.execute_on_load==1`）的批处理任务

当出现`> `时即可输入
- 输入`help`查看提示信息和任务列表
- 输入`batch <batchname>`手动运行批处理任务
- 输入`<appname>`运行用户程序
- 允许前后存在多余空白字符（制表符`\t`或空格` `）

对于特殊字符的处理情况：
- 支持退格键（光标回到行末并删除一个字符）
- 支持左右方向键（左右移后输入时覆盖光标处字符，而非插入，即输入`123[左][左]4`得到的是`143`而非`1423`）
- 禁用上下方向键
- 不支持其它特殊字符，如`delete`、`Ctrl+C`等
- 使用`Ctrl+A X`退出



### 批处理
#### 创建
只需在项目目录中(与 Makefile 同级)创建后缀为`.bat`的文件，文件内容为：
- 第一行为1或0，代表是否在系统启动时自动执行
- 后续每行为一个任务名称
- 允许存在多余空行，任务名称前后允许存在多余制表符`\t`或空格` `

随后运行`make image`即可将批处理写入镜像，无需重新编译内核

目前至多支持16个批处理文件

#### 使用
若批处理文件第一行为1，则系统启动时自动执行

若需手动执行，可以输入`batch <batchname>`即可，其中`batchname`即为文件名，包含`.bat`后缀

亦可输入`help`列出镜像中所有批处理文件

#### 示例
目前已经创建了3个批处理文件，分别是
- `autorun.bat`：演示自动运行
- `manual.bat`：演示非自动运行
- `test.bat`：演示任务名不存在的情况；前后多余空格、空行的情况



---
## 开发调试过程记录

